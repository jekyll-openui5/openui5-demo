/*!
 * OpenUI5
 * (c) Copyright 2009-2021 SAP SE or an SAP affiliate company.
 * Licensed under the Apache License, Version 2.0 - see LICENSE.txt.
 */
sap.ui.define(["sap/ui/fl/apply/_internal/flexState/changes/DependencyHandler","sap/ui/fl/initial/_internal/StorageUtils","sap/ui/fl/Change","sap/ui/fl/Layer","sap/ui/fl/Variant","sap/ui/fl/Utils","sap/ui/fl/LayerUtils","sap/ui/fl/Cache","sap/ui/fl/registry/Settings","sap/ui/fl/apply/_internal/changes/Applier","sap/ui/fl/write/_internal/Storage","sap/ui/core/util/reflection/JsControlTreeModifier","sap/ui/core/Component","sap/ui/model/json/JSONModel","sap/ui/performance/Measurement","sap/base/util/includes","sap/base/util/merge","sap/base/util/restricted/_union","sap/base/util/UriParameters","sap/base/Log","sap/ui/fl/apply/_internal/flexState/controlVariants/VariantManagementState","sap/ui/fl/apply/_internal/flexState/FlexState","sap/ui/fl/write/_internal/condenser/Condenser"],function(D,S,C,L,V,U,a,b,c,A,d,J,e,f,M,i,m,u,g,h,j,F,k){"use strict";var l=function(z){this._mComponent=z;this._mChanges=D.createEmptyDependencyMap();this._bChangesMapCreated=false;this._mChangesInitial=m({},this._mChanges);if(!this._mComponent||!this._mComponent.name){h.error("The Control does not belong to an SAPUI5 component. Personalization and changes for this control might not work as expected.");throw new Error("Missing component name.");}this._aDirtyChanges=[];this._oMessagebundle=undefined;this._mChangesEntries={};this._bHasChangesOverMaxLayer=false;this.HIGHER_LAYER_CHANGES_EXIST="higher_layer_changes_exist";};function n(z,B){var E;if(B instanceof C){E=B;this._mChangesEntries[E.getFileName()]=E;}else{if(!this._mChangesEntries[B.fileName]){this._mChangesEntries[B.fileName]=new C(B);}E=this._mChangesEntries[B.fileName];E.setState(C.states.PERSISTED);}return E;}l.prototype.getComponentName=function(){return this._mComponent.name;};l.prototype.getCacheKey=function(z){return b.getCacheKey(this._mComponent,z);};l.prototype._preconditionsFulfilled=function(z){var B=z instanceof C?z.getDefinition():z;function _(){if((B.fileType==="ctrl_variant")||(B.fileType==="ctrl_variant_change")||(B.fileType==="ctrl_variant_management_change")){return B.variantManagementReference||B.variantReference||(B.selector&&B.selector.id);}}return B.fileType==="change"||_();};l.prototype.getChangesForComponent=function(P,I){return U.getUShellService("URLParsing").then(function(z){this._oUShellURLParsingService=z;return b.getChangesFillingCache(this._mComponent,P,I);}.bind(this)).then(function(P,W){var z=m({},W);var B=P&&P.component&&U.getAppComponentForControl(P.component);var H=S.isStorageResponseFilled(z.changes);if(!H){return[];}var E=z.changes.changes;if(!this._oMessagebundle&&z.messagebundle&&B){if(!B.getModel("i18nFlexVendor")){if(E.some(function(T){return T.layer===L.VENDOR;})){this._oMessagebundle=z.messagebundle;var G=new f(this._oMessagebundle);B.setModel(G,"i18nFlexVendor");}}}var K=P&&P.currentLayer;var N=!(P&&P.ignoreMaxLayerParameter);var O=function(){return true;};if(K){E=a.filterChangeOrChangeDefinitionsByCurrentLayer(E,K);}else if(a.isLayerFilteringRequired(this._oUShellURLParsingService)&&N){O=this._filterChangeForMaxLayer.bind(this);E=E.filter(O);}else if(this._bHasChangesOverMaxLayer&&!N){this._bHasChangesOverMaxLayer=false;return this.HIGHER_LAYER_CHANGES_EXIST;}var Q=z.changes&&P&&P.includeCtrlVariants;var R=this._getAllCtrlVariantChanges(z,Q,O);E=E.concat(R);return this._checkAndGetChangeInstances(E,z);}.bind(this,P));};l.prototype._checkAndGetChangeInstances=function(z,B){return z.filter(this._preconditionsFulfilled).map(n.bind(this,B));};l.prototype._filterChangeForMaxLayer=function(z){if(a.isOverMaxLayer(this._getLayerFromChangeOrChangeContent(z),this._oUShellURLParsingService)){if(!this._bHasChangesOverMaxLayer){this._bHasChangesOverMaxLayer=true;}return false;}return true;};l.prototype._getLayerFromChangeOrChangeContent=function(z){var B;if(z instanceof V||z instanceof C){B=z.getLayer();}else{B=z.layer;}return B;};l.prototype._getAllCtrlVariantChanges=function(z,I,B){if(!I){return j.getInitialChanges({reference:this._mComponent.name});}return["variants","variantChanges","variantDependentControlChanges","variantManagementChanges"].reduce(function(R,E){if(z.changes[E]){return R.concat(z.changes[E]);}return R;},[]).filter(B);};l.prototype.loadChangesMapForComponent=function(z){return this.getChangesForComponent({component:z}).then(B.bind(this));function B(E){M.start("fl.createDependencyMap","Measurement of creating initial dependency map");this._mChanges=D.createEmptyDependencyMap();E.forEach(this.addChangeAndUpdateDependencies.bind(this,z));this._mChangesInitial=m({},this._mChanges);M.end("fl.createDependencyMap","Measurement of creating initial dependency map");this._bChangesMapCreated=true;return this.getChangesMapForComponent.bind(this);}};l.prototype.checkForOpenDependenciesForControl=function(z,B){return D.checkForOpenDependenciesForControl(this._mChanges,J.getControlIdBySelector(z,B),B);};function o(z){var I=m({},this._mChangesInitial.mDependencies);return I[z.getId()];}function p(I,N,z,B){var E;var G=[];I.controlsDependencies.forEach(function(H){if(!J.bySelector(H,z)){E=J.getControlIdBySelector(H,z);G.push(H);this._mChanges.mControlsWithDependencies[E]=this._mChanges.mControlsWithDependencies[E]||[];if(!i(this._mChanges.mControlsWithDependencies[E],B.getId())){this._mChanges.mControlsWithDependencies[E].push(B.getId());}}}.bind(this));I.dependencies=N;I.controlsDependencies=G;if(N.length||G.length){this._mChanges.mDependencies[B.getId()]=I;}}l.prototype.copyDependenciesFromInitialChangesMapSync=function(z,B,E){var I=o.call(this,z);if(I){var N=[];I.dependencies.forEach(function(G){if(B(G)){this._mChanges.mDependentChangesOnMe[G]=this._mChanges.mDependentChangesOnMe[G]||[];this._mChanges.mDependentChangesOnMe[G].push(z.getId());N.push(G);}}.bind(this));p.call(this,I,N,E,z);}return this._mChanges;};l.prototype.copyDependenciesFromInitialChangesMap=function(z,B,E){var I=o.call(this,z);if(I){var N=[];return I.dependencies.reduce(function(P,G){return P.then(function(){return B(G);}).then(function(H){if(H){this._mChanges.mDependentChangesOnMe[G]=this._mChanges.mDependentChangesOnMe[G]||[];this._mChanges.mDependentChangesOnMe[G].push(z.getId());N.push(G);}}.bind(this));}.bind(this),Promise.resolve()).then(function(){p.call(this,I,N,E,z);return this._mChanges;}.bind(this));}return Promise.resolve(this._mChanges);};l.prototype.addChangeAndUpdateDependencies=function(z,B,R){B.setInitialApplyState();if(R){D.insertChange(B,this._mChanges,R);}D.addChangeAndUpdateDependencies(B,z,this._mChanges);};l.prototype._addRunTimeCreatedChangeAndUpdateDependencies=function(z,B){D.addRuntimeChangeAndUpdateDependencies(B,z,this._mChanges,this._mChangesInitial);};l.prototype.getChangesMapForComponent=function(){return this._mChanges;};l.prototype.getAllUIChanges=function(P){var z=u(this.getChangesMapForComponent().aChanges,P.includeDirtyChanges&&this.getDirtyChanges()).filter(function(B){return(Boolean(B)&&B.getFileType()==="change"&&a.compareAgainstCurrentLayer(B.getLayer(),P.layer)===0);});return z;};l.prototype.isChangeMapCreated=function(){return this._bChangesMapCreated;};l.prototype.changesHavingCorrectViewPrefix=function(P,z){var B=P.modifier;var E=P.appComponent;var G=z.getSelector();if(!G||!P){return false;}if(G.viewSelector){var H=B.getControlIdBySelector(G.viewSelector,E);return H===P.viewId;}var I=G.id;if(I){var K;if(z.getSelector().idIsLocal){if(E){K=E.getLocalId(P.viewId);}}else{K=P.viewId;}var N=0;var O;do{N=I.indexOf("--",N);O=I.slice(0,N);N++;}while(O!==K&&N>0);return O===K;}return false;};l.prototype.getChangesForView=function(P){return this.getChangesForComponent(P).then(function(z){return z.filter(this.changesHavingCorrectViewPrefix.bind(this,P));}.bind(this));};l.prototype.addChange=function(z,B){var E=this.addDirtyChange(z);this._addRunTimeCreatedChangeAndUpdateDependencies(B,E);this._mChangesEntries[E.getFileName()]=E;this._addPropagationListener(B);return E;};l.prototype.addDirtyChange=function(z){var N;if(z instanceof C||z instanceof V){N=z;}else{N=new C(z);}if(this._aDirtyChanges.indexOf(N)===-1){this._aDirtyChanges.push(N);}return N;};l.prototype._addPropagationListener=function(z){var B=U.getAppComponentForControl(z);if(B instanceof e){var E=function(P){return!P._bIsSapUiFlFlexControllerApplyChangesOnControl;};var N=B.getPropagationListeners().every(E);if(N){var G=sap.ui.require("sap/ui/fl/FlexControllerFactory");var H=G.create(this.getComponentName());var P=A.applyAllChangesForControl.bind(A,this.getChangesMapForComponent.bind(this),B,H);P._bIsSapUiFlFlexControllerApplyChangesOnControl=true;B.addPropagationListener(P);}}};l.prototype._deleteNotSavedChanges=function(z,B,E){z.filter(function(G){return!B.some(function(H){return G.getId()===H.getId();});}).forEach(function(G){if(E){this.removeChange(G);b.deleteChange(this._mComponent,G.getDefinition());}else{this.deleteChange(G);}}.bind(this));};function q(z,B){var P=z.map(function(G){return G[B]();});var E=P.filter(function(G,I,P){return P.indexOf(G)===I;});return E.length===1;}function s(z,B){var E=false;if(!z||B.length<2){return false;}if(!q(B,"getLayer")){return false;}var G=B[0].getLayer();if(G==="CUSTOMER"||G==="USER"){E=true;}var H=g.fromURL(window.location.href);if(H.has("sap-ui-xx-condense-changes")){E=H.get("sap-ui-xx-condense-changes")==="true";}return E;}function r(z){var E=c.getInstanceOrUndef()&&c.getInstanceOrUndef().isCondensingEnabled();if(E&&!q(z,"getNamespace")){E=false;}return E;}function t(z,B,E,G){this._massUpdateCacheAndDirtyState(B,E);this._deleteNotSavedChanges(z,B,G);}function v(z){if(!z.length){return[];}var B=z[0].getLayer();var P=this._mChanges.aChanges.filter(function(E){return E.getState()===C.states.PERSISTED&&a.compareAgainstCurrentLayer(E.getLayer(),B)===0;});return P.concat(z);}l.prototype.saveDirtyChanges=function(z,B,E,G){var H=E||this._aDirtyChanges;var R=v.call(this,H);var I=(r(R)&&s(z,R));var K=I?R:H;var N=K.slice(0);var O=H.slice(0);var P=this._getRequests(H);var Q=this._getStates(H);if(Q.length===1&&P.length===1&&Q[0]===C.states.NEW){var T=Promise.resolve(N);if(s(z,N)){T=k.condense(z,N);}return T.then(function(W){var X=P[0];var Y=H[0].getDefinition().layer;if(I){return d.condense({allChanges:K,condensedChanges:W,layer:Y,transport:X,isLegacyVariant:false,parentVersion:G}).then(function(Z){t.call(this,K,W,B,true);return Z;}.bind(this));}if(W.length){return d.write({layer:Y,flexObjects:this._prepareDirtyChanges(W),transport:X,isLegacyVariant:false,parentVersion:G}).then(function(Z){t.call(this,K,W,B);return Z;}.bind(this));}this._deleteNotSavedChanges(K,W);}.bind(this));}return this.saveSequenceOfDirtyChanges(O,B,G);};l.prototype.saveSequenceOfDirtyChanges=function(z,B,E){var G;if(E){var N=z.filter(function(H){return H.getState()===C.states.NEW;});G=[].concat(N).shift();}return z.reduce(function(P,H){return P.then(this._performSingleSaveAction(H,G,E)).then(this._updateCacheAndDirtyState.bind(this,H,B));}.bind(this),Promise.resolve());};l.prototype._performSingleSaveAction=function(z,B,E){return function(){switch(z.getState()){case C.states.NEW:if(E!==undefined){E=z===B?E:sap.ui.fl.Versions.Draft;}return d.write({layer:z.getLayer(),flexObjects:[z.getDefinition()],transport:z.getRequest(),parentVersion:E});case C.states.DELETED:return d.remove({flexObject:z.getDefinition(),layer:z.getLayer(),transport:z.getRequest()});}};};l.prototype._updateCacheAndDirtyState=function(z,B){if(!B){if(U.isChangeRelatedToVariants(z)){j.updateVariantsState({reference:this._mComponent.name,changeToBeAddedOrDeleted:z});}else{switch(z.getState()){case C.states.NEW:z.setState(C.states.PERSISTED);b.addChange(this._mComponent,z.getDefinition());break;case C.states.DELETED:b.deleteChange(this._mComponent,z.getDefinition());break;case C.states.DIRTY:z.setState(C.states.PERSISTED);b.updateChange(this._mComponent,z.getDefinition());break;}}}this._aDirtyChanges=this._aDirtyChanges.filter(function(E){return z.getId()!==E.getId();});};l.prototype._massUpdateCacheAndDirtyState=function(z,B){z.forEach(function(E){this._updateCacheAndDirtyState(E,B);},this);};l.prototype._getRequests=function(z){var R=[];z.forEach(function(B){var E=B.getRequest();if(R.indexOf(E)===-1){R.push(E);}});return R;};l.prototype._getStates=function(z){var B=[];z.forEach(function(E){var G=E.getState();if(B.indexOf(G)===-1){B.push(G);}});return B;};l.prototype._prepareDirtyChanges=function(z){var B=[];z.forEach(function(E){B.push(E.getDefinition());});return B;};l.prototype.getDirtyChanges=function(){return this._aDirtyChanges;};l.prototype.deleteChange=function(z,R){var B=this._aDirtyChanges.indexOf(z);if(B>-1){if(z.getState()===C.states.DELETED){return;}this._aDirtyChanges.splice(B,1);this._deleteChangeInMap(z,R);return;}z.markForDeletion();this.addDirtyChange(z);this._deleteChangeInMap(z,R);};l.prototype.removeChange=function(z){var B=this._aDirtyChanges.indexOf(z);if(B>-1){this._aDirtyChanges.splice(B,1);}this._deleteChangeInMap(z);};l.prototype._deleteChangeInMap=function(z,R){var B=z.getId();D.removeChangeFromMap(this._mChanges,B);D.removeChangeFromDependencies(R?this._mChangesInitial:this._mChanges,B);};function w(z,O){return(O.getRequest()==="$TMP"||O.getRequest()==="")&&O.getLayer()===z;}function x(z,O){return O.getState()===C.states.PERSISTED&&O.getLayer()===z;}function y(){var z=[];var B=F.getCompVariantsMap(this.getComponentName());for(var P in B){for(var I in B[P].byId){z.push(B[P].byId[I]);}}return z;}l.prototype.transportAllUIChanges=function(R,z,B,E){return this.getChangesForComponent({currentLayer:B,includeCtrlVariants:true}).then(function(G){var H=y.call(this);G=G.concat(H.filter(w.bind(this,B)));return d.publish({transportDialogSettings:{rootControl:R,styleClass:z},layer:B,reference:this.getComponentName(),localChanges:G,appVariantDescriptors:E});}.bind(this));};l.prototype._getChangesFromMapByNames=function(N){return this._mChanges.aChanges.filter(function(z){return N.indexOf(z.getFileName())!==-1;});};l.prototype.removeDirtyChanges=function(z,B,E,G,H){var I=[].concat(z||[]);var K=this._aDirtyChanges;var N=K.filter(function(O){var P=true;if(I.length&&!I.includes(O.getLayer())){return false;}if(G&&O.getDefinition().support.generator!==G){return false;}if(E){var Q=O.getSelector();P=E.getId()===J.getControlIdBySelector(Q,B);}if(H){P=P&&H.indexOf(O.getChangeType())!==-1;}return P;});N.forEach(function(O){var P=K.indexOf(O);K.splice(P,1);});return Promise.resolve(N);};l.prototype.resetChanges=function(z,G,B,E){var H=B&&B.length>0;var I=E&&E.length>0;var K=c.getInstanceOrUndef()&&c.getInstanceOrUndef().isPublicLayerAvailable();var N=G===undefined&&B===undefined&&E===undefined;var O=[];if(K&&N){O=y.call(this).filter(x.bind(this,z));}return this.getChangesForComponent({currentLayer:z,includeCtrlVariants:true}).then(function(P){P=P.concat(O);var Q={reference:this.getComponentName(),layer:z,changes:P};if(G){Q.generator=G;}if(H){Q.selectorIds=B;}if(I){Q.changeTypes=E;}return d.reset(Q);}.bind(this)).then(function(R){var P=[];if(B||E){var Q=[];if(R&&R.response&&R.response.length>0){R.response.forEach(function(T){Q.push(T.fileName);});}b.removeChanges(this._mComponent,Q);P=this._getChangesFromMapByNames(Q);}return P;}.bind(this));};l.prototype.getResetAndPublishInfo=function(P){return d.getFlexInfo(P);};return l;});
